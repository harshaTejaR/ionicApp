import{a as ee,e as te,n as re,p as se,r as oe,s as ne,v as ie}from"./chunk-RPLSJVHM.js";import{a as y,b as f,c as b}from"./chunk-7YESJSHY.js";import"./chunk-SQK554CQ.js";import{c as W,d as J,e as R,f as V,g as z,i as $,k as H,l as q,m as K,n as Q,u as X,w as Y,z as Z}from"./chunk-4UMYDNEB.js";import{C as w,E as n,F as a,G as m,K as C,L as j,M as E,U as l,V as U,W as F,a as x,e as D,fa as M,g as P,ha as G,hb as B,ib as L,k,l as O,ma as N,r as T,s as g,t as I,v as _,z as A}from"./chunk-BP6JKRVK.js";import"./chunk-NZERDRCC.js";import"./chunk-QUJFQN2Y.js";import"./chunk-RK5ZR5SZ.js";import"./chunk-ZBJKKZLI.js";import"./chunk-LAQWGKBO.js";import"./chunk-6XMIRX4Z.js";import"./chunk-YWH2TDL6.js";import"./chunk-VSX7XORW.js";import"./chunk-QTYPG2AS.js";import"./chunk-IXUU6NU2.js";import"./chunk-6TZ2664W.js";import{a as p,b as S}from"./chunk-3J7GGTVR.js";import"./chunk-ACJ2AYCZ.js";import"./chunk-4M2GG73W.js";import"./chunk-LBMIQEU6.js";import"./chunk-WI5MSH4N.js";import"./chunk-Z7SRCWNX.js";import"./chunk-CKP3SGE2.js";import"./chunk-F7PGTD24.js";import"./chunk-GUJXBZDQ.js";import"./chunk-7WXQK2V2.js";import"./chunk-YZURWZAQ.js";import"./chunk-CKIBZVXW.js";import"./chunk-PS2NURIG.js";import"./chunk-4U6PRYVA.js";import"./chunk-FXFZIWDD.js";import"./chunk-CSG5OQLY.js";import"./chunk-VMHM3MLJ.js";import"./chunk-UPDXPL72.js";import"./chunk-C5RQ2IC2.js";import"./chunk-42C7ZIID.js";import{a as v,f as o}from"./chunk-RW4GY4BD.js";var ae=(()=>{let i=class i{constructor(e){this.platform=e,this.currentUserSubject=new x(null),this.currentUser$=this.currentUserSubject.asObservable(),this.users=[],this.USERS_FILE="users.json",this.initializeGoogleAuth(),this.loadUsers(),this.restoreUserSession()}initializeGoogleAuth(){return o(this,null,function*(){try{yield this.platform.ready(),yield f.initialize({clientId:b.googleAuth.clientId,scopes:b.googleAuth.scopes,grantOfflineAccess:!0})}catch(e){console.error("Failed to initialize Google Auth:",e)}})}signInWithGoogle(){return o(this,null,function*(){var e;try{if(console.log("Starting Google Sign In..."),!f)throw console.error("GoogleAuth is not available"),new Error("GoogleAuth is not properly initialized");let t=yield f.signIn();if(console.log("Google Sign In successful:",t),!t||!t.email)throw console.error("Invalid Google user data received"),new Error("Invalid user data received from Google");let r={id:t.id,email:t.email,name:t.name,imageUrl:t.imageUrl,registeredAt:new Date().toISOString(),authMethod:"google"};console.log("User object created:",r);let s=this.users.find(c=>c.id===r.id);return s?(Object.assign(s,r),yield this.saveUsers(),console.log("Existing user updated in local storage")):(this.users.push(r),yield this.saveUsers(),console.log("New user saved to local storage")),this.currentUserSubject.next(r),this.saveUserSession(r),r}catch(t){throw console.error("Google Sign In failed:",t),(t==null?void 0:t.error)==="popup_closed_by_user"?(console.warn("User closed the Google sign-in popup"),new Error("Sign-in was cancelled. Please try again.")):(t==null?void 0:t.error)==="access_denied"?(console.warn("User denied access to Google account"),new Error("Access denied. Please grant permission to continue.")):(e=t==null?void 0:t.message)!=null&&e.includes("redirect_uri_mismatch")?(console.error("OAuth configuration error"),new Error("Authentication configuration error. Please contact support.")):(console.error("Unknown sign-in error:",t),new Error("Sign-in failed. Please try again later."))}})}registerWithEmail(e,t,r){return o(this,null,function*(){try{if(this.getUserByEmail(e))throw new Error("User with this email already exists");if(!this.isValidEmail(e))throw new Error("Please enter a valid email address");if(t.length<6)throw new Error("Password must be at least 6 characters long");let c={id:this.generateUserId(),email:e.toLowerCase(),name:r,registeredAt:new Date().toISOString(),authMethod:"email",password:yield this.hashPassword(t)};this.users.push(c),yield this.saveUsers();let h=v({},c);return delete h.password,this.currentUserSubject.next(h),this.saveUserSession(h),console.log("User registered successfully:",h),h}catch(s){throw console.error("Registration failed:",s),s}})}signInWithEmail(e,t){return o(this,null,function*(){try{let r=this.getUserByEmail(e.toLowerCase());if(!r)throw new Error("Invalid email or password");if(r.authMethod!=="email")throw new Error("This email is registered with a different method");if(!(yield this.verifyPassword(t,r.password)))throw new Error("Invalid email or password");let c=v({},r);return delete c.password,this.currentUserSubject.next(c),this.saveUserSession(c),console.log("User signed in successfully:",c),c}catch(r){throw console.error("Sign in failed:",r),r}})}signOut(){return o(this,null,function*(){var e;try{yield this.saveWorkProgressBeforeLogout(),((e=this.currentUserSubject.value)==null?void 0:e.authMethod)==="google"&&(yield f.signOut()),this.currentUserSubject.next(null),this.clearUserSession(),console.log("User signed out successfully")}catch(t){console.error("Sign out failed:",t)}})}getCurrentUser(){return o(this,null,function*(){let e=this.getCurrentUserSync();if(e)return e;try{let t=yield f.signIn();if(t){let r={id:t.id,email:t.email,name:t.name,imageUrl:t.imageUrl,registeredAt:new Date().toISOString(),authMethod:"google"};return this.currentUserSubject.next(r),this.saveUserSession(r),r}return null}catch{return null}})}isAuthenticated(){return this.currentUserSubject.value!==null}getUsers(){return this.users}getUserById(e){return this.users.find(t=>t.id===e)}getUserByEmail(e){return this.users.find(t=>t.email===e)}loadUsers(){return o(this,null,function*(){try{let e=yield y.readFile({path:this.USERS_FILE,directory:p.Data,encoding:S.UTF8});this.users=JSON.parse(e.data)||[]}catch{console.log("No users file found, creating new one"),this.users=[],yield this.saveUsers()}})}saveUsers(){return o(this,null,function*(){try{yield y.writeFile({path:this.USERS_FILE,data:JSON.stringify(this.users,null,2),directory:p.Data,encoding:S.UTF8})}catch(e){console.error("Error saving users:",e)}})}requestPasswordReset(e){return o(this,null,function*(){let t=this.getUserByEmail(e.toLowerCase());if(!t)throw new Error("Email not found");if(t.authMethod!=="email")throw new Error("Password reset not supported for this account");t.resetToken=this.generateToken(),t.resetTokenExpiry=new Date(Date.now()+36e5).toISOString(),yield this.saveUsers(),console.log("Reset token generated and saved for user:",t.email)})}resetPassword(e,t,r){return o(this,null,function*(){let s=this.getUserByEmail(e.toLowerCase());if(!s)throw new Error("User not found");if(!s.resetToken||s.resetToken!==t)throw new Error("Invalid password reset token");if(!s.resetTokenExpiry||new Date(s.resetTokenExpiry)<new Date)throw new Error("Password reset token has expired");if(r.length<6)throw new Error("Password must be at least 6 characters long");s.password=yield this.hashPassword(r),delete s.resetToken,delete s.resetTokenExpiry,yield this.saveUsers(),console.log("Password reset successful for user:",s.email)})}generateUserId(){return"user_"+Date.now().toString()+"_"+Math.random().toString(36).substr(2,9)}generateToken(){return Math.random().toString(36).substr(2,15)+Date.now().toString(36)}isValidEmail(e){return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)}hashPassword(e){return o(this,null,function*(){let r=new TextEncoder().encode(e+"salt_key_for_hashing"),s=yield crypto.subtle.digest("SHA-256",r);return Array.from(new Uint8Array(s)).map(h=>h.toString(16).padStart(2,"0")).join("")})}verifyPassword(e,t){return o(this,null,function*(){return(yield this.hashPassword(e))===t})}getCurrentUserSync(){return this.currentUserSubject.value}isEmailRegistered(e){return this.getUserByEmail(e.toLowerCase())!==void 0}getTotalUsers(){return this.users.length}getUsersByAuthMethod(e){return this.users.filter(t=>t.authMethod===e)}restoreUserSession(){return o(this,null,function*(){try{let e=localStorage.getItem("currentUser");if(e){let t=JSON.parse(e);this.currentUserSubject.next(t),console.log("User session restored:",t)}}catch(e){console.error("Failed to restore user session:",e)}})}saveUserSession(e){try{localStorage.setItem("currentUser",JSON.stringify(e))}catch(t){console.error("Failed to save user session:",t)}}clearUserSession(){try{localStorage.removeItem("currentUser")}catch(e){console.error("Failed to clear user session:",e)}}saveWorkProgressBeforeLogout(){return o(this,null,function*(){try{let e=this.getCurrentUserSync();if(!e)return;let t={inventoryData:this.getInventoryData(),currentTab:this.getCurrentTab(),formData:this.getFormData(),timestamp:new Date().toISOString()},r=`work_progress_${e.id}.json`;yield y.writeFile({path:r,data:JSON.stringify(t,null,2),directory:p.Data,encoding:S.UTF8}),console.log("Work progress saved before logout")}catch(e){console.error("Error saving work progress before logout:",e)}})}getInventoryData(){try{let e=localStorage.getItem("inventoryData");return e?JSON.parse(e):[]}catch{return[]}}getCurrentTab(){return localStorage.getItem("currentTab")||"inventory"}getFormData(){try{let e=localStorage.getItem("formData");return e?JSON.parse(e):{}}catch{return{}}}restoreWorkProgress(){return o(this,null,function*(){try{let e=this.getCurrentUserSync();if(!e)return;let t=`work_progress_${e.id}.json`,r=yield y.readFile({path:t,directory:p.Data,encoding:S.UTF8}),s=JSON.parse(r.data);s&&(s.inventoryData&&localStorage.setItem("inventoryData",JSON.stringify(s.inventoryData)),s.currentTab&&localStorage.setItem("currentTab",s.currentTab),s.formData&&localStorage.setItem("formData",JSON.stringify(s.formData)),console.log("Work progress restored successfully"))}catch(e){console.log("No work progress found or error restoring:",e)}})}};i.\u0275fac=function(t){return new(t||i)(P(L))},i.\u0275prov=D({token:i,factory:i.\u0275fac,providedIn:"root"});let u=i;return u})();function ue(u,i){if(u&1){let d=C();n(0,"ion-card")(1,"ion-card-header")(2,"ion-card-title")(3,"ion-avatar",3),m(4,"img",4),a(),l(5),a()(),n(6,"ion-card-content")(7,"ion-item"),m(8,"ion-icon",5),n(9,"ion-label")(10,"h3"),l(11,"Email"),a(),n(12,"p"),l(13),a()()(),n(14,"ion-item"),m(15,"ion-icon",6),n(16,"ion-label")(17,"h3"),l(18,"Authentication Method"),a(),n(19,"p"),l(20),a()()(),n(21,"ion-item"),m(22,"ion-icon",7),n(23,"ion-label")(24,"h3"),l(25,"Member Since"),a(),n(26,"p"),l(27),a()()(),n(28,"ion-item"),m(29,"ion-icon",8),n(30,"ion-label")(31,"h3"),l(32,"Session Status"),a(),n(33,"p"),l(34,"Active - Work progress automatically saved"),a()()(),n(35,"ion-button",9),j("click",function(){k(d);let t=E();return O(t.logout())}),m(36,"ion-icon",10),l(37," Logout & Save Progress "),a()()()}if(u&2){let d=E();g(4),w("src",d.currentUser.imageUrl||"assets/avatar-placeholder.png",T),g(),F(" ",d.currentUser.name," "),g(8),U(d.currentUser.email),g(7),U(d.currentUser.authMethod==="email"?"Email & Password":"Google Sign-In"),g(7),U(d.formatDate(d.currentUser.registeredAt))}}var be=(()=>{let i=class i{constructor(e,t){this.authService=e,this.router=t,this.currentUser=null,ee({logOutOutline:se,personCircleOutline:ne,mailOutline:oe,keyOutline:re,calendarOutline:te,saveOutline:ie})}ngOnInit(){this.currentUser=this.authService.getCurrentUserSync(),this.currentUser||this.router.navigate(["/login"])}logout(){return o(this,null,function*(){yield this.authService.signOut(),this.router.navigate(["/login"])})}formatDate(e){return new Date(e).toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"})}};i.\u0275fac=function(t){return new(t||i)(I(ae),I(N))},i.\u0275cmp=_({type:i,selectors:[["app-profile"]],decls:6,vars:3,consts:[[3,"translucent"],[1,"ion-padding",3,"fullscreen"],[4,"ngIf"],["slot","start"],[3,"src"],["name","mail-outline","slot","start"],["name","key-outline","slot","start"],["name","calendar-outline","slot","start"],["name","save-outline","slot","start"],["expand","block","color","danger",3,"click"],["name","logOutOutline","slot","start"]],template:function(t,r){t&1&&(n(0,"ion-header",0)(1,"ion-toolbar")(2,"ion-title"),l(3,"Profile"),a()()(),n(4,"ion-content",1),A(5,ue,38,5,"ion-card",2),a()),t&2&&(w("translucent",!0),g(4),w("fullscreen",!0),g(),w("ngIf",r.currentUser))},dependencies:[H,q,X,Y,R,z,$,V,J,W,K,Q,Z,G,M,B],encapsulation:2});let u=i;return u})();export{be as ProfilePage};
